<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EREN | Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: radial-gradient(circle at top, #001f16, #0b0b0b);
      color: white;
      min-height: 100vh;
      padding: 16px;
    }

    h1 {
      color: #00ff9c;
      text-align: center;
      letter-spacing: 2px;
    }

    .box {
      max-width: 420px;
      margin: auto;
      background: rgba(0,0,0,.85);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(0,255,156,.25);
      box-shadow: 0 0 20px rgba(0,255,156,.15);
    }

    input, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 6px;
      border: none;
      background: #111;
      color: white;
      font-size: 14px;
      outline: none;
    }

    textarea { resize: vertical; }

    button {
      background: linear-gradient(45deg,#00ff9c,#00c97a);
      font-weight: bold;
      cursor: pointer;
      transition: .3s;
    }

    button:hover {
      transform: scale(1.03);
      box-shadow: 0 0 12px rgba(0,255,156,.6);
    }

    button.danger {
      background: #aa1f1f;
    }

    img.preview {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
      margin-top: 6px;
      display: none;
      border: 1px solid rgba(0,255,156,.3);
    }

    .project-list {
      margin-top: 30px;
    }

    .project-item {
      border: 1px solid rgba(0,255,156,.2);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 12px;
      background: #111;
    }

    .project-item h3 {
      color: #00ff9c;
      margin: 0 0 6px;
    }

    .project-item button {
      margin-top: 6px;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 500;
      padding: 16px;
    }

    .modal-box {
      background: #111;
      padding: 20px;
      border-radius: 12px;
      max-width: 420px;
      width: 100%;
      border: 1px solid rgba(0,255,156,.3);
    }
  </style>
</head>

<body>

<h1>EREN ADMIN</h1>

<div class="box">
  <h3>Upload New Project</h3>

  <input id="title" placeholder="Project title">
  <textarea id="description" placeholder="Project description"></textarea>
  <input id="tutorial" placeholder="Tutorial link">
  <input id="projectLink" placeholder="Project link">

  <input type="file" id="image" accept="image/*">
  <img id="preview" class="preview">

  <button id="uploadBtn">Upload Project</button>
</div>

<div class="box project-list">
  <h3>Existing Projects</h3>
  <div id="projects"></div>
</div>

<!-- EDIT MODAL -->
<div class="modal" id="editModal">
  <div class="modal-box">
    <h3>Edit Project</h3>
    <input id="editTitle">
    <textarea id="editDescription"></textarea>
    <input id="editTutorial">
    <input id="editProjectLink">

    <button onclick="saveEdit()">Save</button>
    <button class="danger" onclick="closeEdit()">Cancel</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, getDocs, doc,
    updateDoc, deleteDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAXZQi1Wdwf7oHRVapWNGgcCYtd4Dy5kQk",
    authDomain: "eren-c4b30.firebaseapp.com",
    projectId: "eren-c4b30"
  };

  const ADMIN_UID = "pBMj3WNqc4WmStAlNHQwh4REHlm2";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const titleInput = document.getElementById("title");
  const descInput = document.getElementById("description");
  const tutorialInput = document.getElementById("tutorial");
  const projectInput = document.getElementById("projectLink");
  const imageInput = document.getElementById("image");
  const previewImg = document.getElementById("preview");
  const projectsEl = document.getElementById("projects");

  let editingId = null;

  imageInput.onchange = () => {
    const file = imageInput.files[0];
    if (!file) return;
    previewImg.src = URL.createObjectURL(file);
    previewImg.style.display = "block";
  };

  onAuthStateChanged(auth, user => {
    if (!user || user.uid !== ADMIN_UID) {
      window.location.href = "home.html";
    } else {
      loadProjects();
    }
  });

  async function uploadToImgBB(file) {
    const form = new FormData();
    form.append("image", file);

    const res = await fetch(
      "https://api.imgbb.com/1/upload?key=efd9e3255bb9ff4053c312897dd157c7",
      { method: "POST", body: form }
    );

    const data = await res.json();
    if (!data?.data?.url) throw new Error("Image upload failed");
    return data.data.url;
  }

  document.getElementById("uploadBtn").onclick = async () => {
    const file = imageInput.files[0];
    if (!titleInput.value || !descInput.value || !tutorialInput.value || !projectInput.value || !file) {
      alert("Fill all fields");
      return;
    }

    const imageURL = await uploadToImgBB(file);

    await addDoc(collection(db, "projects"), {
      title: titleInput.value.trim(),
      description: descInput.value.trim(),
      tutorialLink: tutorialInput.value.trim(),
      projectLink: projectInput.value.trim(),
      image: imageURL,
      likes: 0,
      likedBy: {},
      createdAt: serverTimestamp()
    });

    location.reload();
  };

  async function loadProjects() {
    const snap = await getDocs(collection(db, "projects"));
    projectsEl.innerHTML = "";

    snap.forEach(d => {
      const p = d.data();
      projectsEl.innerHTML += `
        <div class="project-item">
          <h3>${p.title}</h3>
          <button onclick="openEdit('${d.id}','${p.title}','${p.description}','${p.tutorialLink}','${p.projectLink}')">
            ‚úèÔ∏è Edit
          </button>
          <button class="danger" onclick="deleteProject('${d.id}')">
            üóë Delete
          </button>
        </div>
      `;
    });
  }

  window.openEdit = (id, t, d, tut, link) => {
    editingId = id;
    editTitle.value = t;
    editDescription.value = d;
    editTutorial.value = tut;
    editProjectLink.value = link;
    document.getElementById("editModal").style.display = "flex";
  };

  window.closeEdit = () => {
    document.getElementById("editModal").style.display = "none";
  };

  window.saveEdit = async () => {
    await updateDoc(doc(db, "projects", editingId), {
      title: editTitle.value,
      description: editDescription.value,
      tutorialLink: editTutorial.value,
      projectLink: editProjectLink.value
    });
    closeEdit();
    loadProjects();
  };

  window.deleteProject = async (id) => {
    if (!confirm("Delete this project permanently?")) return;
    await deleteDoc(doc(db, "projects", id));
    loadProjects();
  };
</script>

</body>
</html>
